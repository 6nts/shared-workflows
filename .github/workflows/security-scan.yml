name: Security Scan

on:
  workflow_call:
    inputs:
      scan-path:
        description: 'Project path name'
        required: true
        type: string

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trivy (v0.61.1)
        run: |
          echo "üì• Instalando Trivy v0.61.1..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.61.1

      - name: Prepare Go modules
        run: |
          cd ${{ inputs.scan-path }}
          go mod tidy
          go mod download

      - name: Trivy - Scan vulnerabilities
        run: |
          echo "üîç Escaneando dependencias y c√≥digo fuente..."
          trivy fs --exit-code 1 --severity CRITICAL,HIGH ${{ inputs.scan-path }}

      - name: Trivy - Secret scan (informativo)
        run: |
          echo "üîê Buscando secretos..."
          trivy fs --scanners secret --exit-code 0 --severity CRITICAL,HIGH,MEDIUM,LOW ${{ inputs.scan-path }}

      - name: Trivy - Config scan (informativo)
        run: |
          echo "‚öôÔ∏è Escaneo de configuraci√≥n insegura..."
          trivy config --exit-code 0 --severity CRITICAL,HIGH,MEDIUM,LOW ${{ inputs.scan-path }}
